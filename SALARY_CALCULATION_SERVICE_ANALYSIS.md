# salary-calculation.service.ts 責務抽出レポート

## 📊 概要

**ファイル**: `src/app/services/salary-calculation.service.ts`  
**総行数**: 1953行  
**メソッド数**: 約30個  
**責務数**: 8つの主要カテゴリ

---

## 📋 分類1：定時決定（算定基礎届）ロジック

### メソッド一覧

- **getAprilToJuneValues** (273-287行)
  - 4〜6月の給与データ（total, fixed, variable）を配列で取得
  - 定時決定の基礎データ収集

- **getExcludedMonths** (289-317行)
  - 4〜6月のうち、支払基礎日数が17日未満の月を算定除外
  - 除外理由を配列で返す

- **calculateAverage** (319-368行)
  - 除外月を考慮して平均報酬を計算
  - 3ヶ月平均、2ヶ月平均、1ヶ月特例の処理
  - 使用した月と理由を返す

- **calculateTeijiKettei** (389-479行)
  - 定時決定のメイン処理
  - 4〜6月の平均報酬から等級・標準報酬月額を決定
  - 1000円未満四捨五入処理
  - 適用開始月（原則9月）を設定
  - 全部除外時の特例処理

### 役割
定時決定（算定基礎届）の計算ロジック。4〜6月の給与データから平均報酬を算出し、標準報酬月額を決定する。

### 行数合計: 約207行

---

## 📋 分類2：随時改定ロジック

### メソッド一覧

- **getFixed3Months** (482-498行)
  - 変動月を含む3ヶ月の固定的賃金を取得

- **getExcludedMonthsForSuiji** (500-539行)
  - 随時改定の算定除外月を判定
  - 無給月、欠勤控除（前月比20%以上低下）、産休・育休・休職月を除外

- **calculateAverageForSuiji** (541-564行)
  - 随時改定用の平均計算（固定的賃金ベース）
  - 1ヶ月、2ヶ月、3ヶ月の特例対応

- **detectFixedSalaryChanges** (572-599行)
  - 1〜12月の固定的賃金の変動を検出
  - 変動があった月のリストを返す

- **calculateFixedSalaryChangeSuiji** (610-729行)
  - 固定的賃金の変動に基づく随時改定を判定
  - 変動月を含む3ヶ月の総支給額で平均を計算
  - 2等級以上の差で随時改定成立を判定
  - 適用開始月（変動月の4ヶ月後）を計算

- **isWithin3MonthsAfterJoin** (731-753行)
  - 資格取得後3ヶ月以内かどうかを判定
  - 随時改定の除外条件チェック

- **calculateSuijiKettei** (755-859行)
  - 随時改定のメイン処理（固定的賃金ベース）
  - 変動月を含む3ヶ月の固定的賃金で平均を計算
  - 現行等級と新等級を比較して2等級以上差で成立判定

- **checkRehabSuiji** (871-932行)
  - 復職（産休・育休終了）に伴う随時改定をチェック
  - 復職月・翌月・翌々月を監視対象とする

- **checkFixedSalaryChangeForMonth** (937-1088行) - private
  - 特定月における固定的賃金の変動を検出
  - 随時改定候補を判定（復職用）

- **getRehabHighlightMonths** (1532-1551行)
  - 復職月・翌月・翌々月を取得（UI表示用）

### 役割
随時改定の計算ロジック。固定的賃金の変動を検出し、3ヶ月平均で等級を判定。2等級以上の差で随時改定が成立する。

### 行数合計: 約617行

---

## 📋 分類3：資格取得時決定ロジック

### メソッド一覧

- **calculateShikakuShutoku** (1640-1780行)
  - 資格取得時決定のメイン処理
  - 入社月の給与、または翌月の給与を使用
  - 1000円未満四捨五入処理
  - 等級・標準報酬月額を決定
  - Firestoreに保存（既存値があれば上書きしない）

### 役割
資格取得時決定の計算ロジック。入社月または翌月の給与から標準報酬月額を決定する。

### 行数合計: 約141行

---

## 📋 分類4：報酬集計ロジック

### メソッド一覧

- **getFixedSalary** (233-236行) - private
  - 給与データから固定的賃金を取得（後方互換性対応）

- **getVariableSalary** (241-244行) - private
  - 給与データから非固定的賃金を取得（後方互換性対応）

- **getTotalSalary** (249-256行) - private
  - 給与データから総支給を取得（後方互換性対応）

- **calculateSalaryTotals** (1785-1808行)
  - 給与項目マスタから固定/非固定の合計を計算

- **getSalaryFromData** (1813-1839行)
  - 給与データから固定/非固定/総支給を取得（後方互換性対応）
  - 新しい項目別形式と既存形式の両方に対応

- **getAverageForAprToJun** (1847-1870行)
  - 4〜6月の平均報酬を計算（3ヶ月分すべて存在する場合のみ）

### 役割
給与データの集計・取得ロジック。固定的賃金、非固定的賃金、総支給の取得と、平均報酬の計算を行う。

### 行数合計: 約100行

---

## 📋 分類5：等級判定ロジック

### メソッド一覧

- **STANDARD_TABLE** (119-133行) - 定数
  - 協会けんぽ（一般）標準報酬月額テーブル（簡略化版）
  - 13等級の下限・上限・標準報酬月額を定義

- **findGrade** (370-387行)
  - 平均報酬から等級と標準報酬月額を検索
  - Firestoreから読み込んだテーブルを優先、なければSTANDARD_TABLEを使用

- **getStandardMonthlyRemuneration** (1878-1886行)
  - 平均報酬から標準報酬月額を取得
  - findGradeのラッパー

### 役割
標準報酬月額テーブルから等級を判定するロジック。平均報酬に基づいて等級と標準報酬月額を決定する。

### 行数合計: 約30行

---

## 📋 分類6：免除判定・加入区分判定ロジック

### メソッド一覧

- **calculateAgeForMonth** (146-163行) - private
  - 指定年月における年齢を計算
  - その月の1日時点の年齢を返す

- **isCareInsuranceApplicable** (172-179行)
  - 指定年月が介護保険適用対象かどうかを判定
  - 第2号被保険者（40〜64歳）の場合true

- **getCareInsuranceType** (191-228行)
  - 指定年月における介護保険区分を取得
  - 'none'（39歳まで）、'type2'（40〜64歳）、'type1'（65歳以上）を返す

- **calculateAge** (258-270行)
  - 現在日時における年齢を計算

- **isExemptMonth** (1107-1114行)
  - 指定月が免除月（産前産後休業・育児休業）かどうかを判定

- **getExemptReasonForMonth** (1123-1125行)
  - 指定年月の免除理由を取得（産休・育休・休職）

### 役割
年齢計算、介護保険区分判定、産休・育休免除判定のロジック。保険料計算の前提条件を判定する。

### 行数合計: 約100行

---

## 📋 分類7：共通計算式（保険料計算）

### メソッド一覧

- **calculateMonthlyPremiums** (1127-1530行)
  - 月次給与の保険料を計算（統合版）
  - 産休・育休免除、年齢到達、標準報酬月額、資格取得月を統合考慮
  - 健康保険・介護保険・厚生年金の保険料を計算
  - 10円未満切り捨て処理
  - 月末在籍判定、資格取得月判定、年齢到達判定を含む

- **calculateInsurancePremiums** (1897-1951行)
  - 月次保険料を計算（簡易版）
  - 標準報酬月額と料率から保険料を計算
  - 介護保険区分を考慮
  - 10円未満切り捨て処理

### 役割
保険料計算のロジック。標準報酬月額と料率から健康保険・介護保険・厚生年金の保険料を計算する。

### 行数合計: 約458行

---

## 📋 分類8：その他の補助ロジック

### メソッド一覧

- **getSalaryKey** (135-137行)
  - 給与データのキーを作成（`${employeeId}_${month}`形式）

- **addBonusAsSalary** (1560-1630行)
  - 給与扱いとなった賞与を標準報酬月額に合算
  - Firestoreの給与データを更新

### 役割
補助的なユーティリティロジック。給与キーの作成や賞与の合算処理を行う。

### 行数合計: 約73行

---

## 📊 統計サマリー

| 分類 | 行数 | メソッド数 | 割合 |
|------|------|-----------|------|
| 定時決定ロジック | 207行 | 4個 | 10.6% |
| 随時改定ロジック | 617行 | 10個 | 31.6% |
| 資格取得時決定ロジック | 141行 | 1個 | 7.2% |
| 報酬集計ロジック | 100行 | 6個 | 5.1% |
| 等級判定ロジック | 30行 | 3個 | 1.5% |
| 免除判定・加入区分判定ロジック | 100行 | 6個 | 5.1% |
| 共通計算式（保険料計算） | 458行 | 2個 | 23.4% |
| その他の補助ロジック | 73行 | 2個 | 3.7% |
| **合計** | **1726行** | **34個** | **88.4%** |

※ 残りの約227行は、import文、インターフェース定義、コンストラクタ、コメントなど

---

## 🎯 分割提案

### 提案1：定時決定計算サービス
**ファイル名**: `teiji-calculation.service.ts`  
**対象メソッド**: 分類1の全メソッド  
**想定行数**: 約250行（インターフェース定義含む）

### 提案2：随時改定計算サービス
**ファイル名**: `suiji-calculation.service.ts`  
**対象メソッド**: 分類2の全メソッド  
**想定行数**: 約650行（インターフェース定義含む）

### 提案3：資格取得時決定計算サービス
**ファイル名**: `shikaku-calculation.service.ts`  
**対象メソッド**: 分類3の全メソッド  
**想定行数**: 約180行（インターフェース定義含む）

### 提案4：等級判定サービス（共通）
**ファイル名**: `grade-determination.service.ts`  
**対象メソッド**: 分類5の全メソッド  
**想定行数**: 約100行（STANDARD_TABLE含む）

### 提案5：報酬集計サービス（共通）
**ファイル名**: `salary-aggregation.service.ts`  
**対象メソッド**: 分類4の全メソッド  
**想定行数**: 約150行

### 提案6：免除判定サービス（共通）
**ファイル名**: `exemption-determination.service.ts`  
**対象メソッド**: 分類6の全メソッド  
**想定行数**: 約150行

### 提案7：保険料計算サービス
**ファイル名**: `premium-calculation.service.ts`  
**対象メソッド**: 分類7の全メソッド  
**想定行数**: 約500行

### 提案8：補助ユーティリティサービス
**ファイル名**: `salary-helper.service.ts`  
**対象メソッド**: 分類8の全メソッド  
**想定行数**: 約100行

---

## ⚠️ 注意事項

1. **依存関係の整理**
   - 各サービス間の依存関係を明確にする
   - 循環依存を避ける

2. **インターフェースの配置**
   - 各サービスに必要なインターフェースを適切に配置
   - 共通インターフェースは別ファイルに分離を検討

3. **後方互換性**
   - 既存の呼び出し元への影響を最小限に
   - 段階的な移行を推奨

4. **テストの充実**
   - 分割前後で動作が変わらないことを確認
   - 各サービスの単体テストを追加

---

**作成日**: 2025年1月  
**分析対象**: `src/app/services/salary-calculation.service.ts` (1953行)

