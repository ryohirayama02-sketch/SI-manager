<h2>賞与入力</h2>

<div class="card" style="max-width: 400px; margin-bottom: 1rem;">
  <div class="form-group">
    <label>年度：</label>
    <select [(ngModel)]="year" (change)="onYearChange()" class="form-control" [ngModelOptions]="{standalone: true}">
      <option *ngFor="let y of availableYears" [value]="y">{{ y }}年</option>
    </select>
  </div>
</div>

<form (ngSubmit)="onSubmit()" class="bonus-form card">
  <div class="form-group">
    <label for="employee">従業員 <span class="required">*</span></label>
    <select
      id="employee"
      [(ngModel)]="selectedEmployeeId"
      (change)="onInputChange()"
      name="employee"
      class="form-control"
      required
    >
      <option value="">選択してください</option>
      <option *ngFor="let emp of employees" [value]="emp.id">
        {{ emp.name }}
      </option>
    </select>
  </div>

  <div class="form-group">
    <label for="paymentMonth">支給月 <span class="required">*</span></label>
    <select
      id="paymentMonth"
      [(ngModel)]="paymentMonth"
      (change)="onMonthChange(paymentMonth)"
      name="paymentMonth"
      class="form-control"
      required
    >
      <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">
        {{ m }}月
      </option>
    </select>
  </div>

  <div class="form-group">
    <label for="bonusAmount">賞与額 <span class="required">*</span></label>
    <input
      id="bonusAmount"
      type="text"
      [value]="bonusAmountDisplay"
      (input)="onBonusAmountInput($event)"
      (blur)="onBonusAmountBlur($event)"
      name="bonusAmount"
      placeholder="賞与額を入力"
      class="form-control"
      required
    />
  </div>

  <div class="form-group">
    <label>
      <input
        type="checkbox"
        [(ngModel)]="isExempt"
        (change)="onInputChange()"
        name="isExempt"
      />
      育休・産休中
    </label>
  </div>

  <button type="submit" class="btn-primary">保存</button>
</form>

<div *ngIf="calculationResult as cr" class="calculation-card card">
  <!-- エラー・警告メッセージ -->
  <div *ngIf="calculationResult?.errorMessages?.length" class="error-box">
    <h4>エラー</h4>
    <ul>
      <li *ngFor="let err of calculationResult?.errorMessages">{{ err }}</li>
    </ul>
  </div>

  <div *ngIf="calculationResult?.warningMessages?.length" class="warning-box">
    <h4>警告</h4>
    <ul>
      <li *ngFor="let w of calculationResult?.warningMessages">{{ w }}</li>
    </ul>
  </div>
  <h3>保険料計算結果</h3>

  <!-- 1. 標準賞与額・上限調整結果 -->
  <div class="info-section">
    <h4>標準賞与額・上限調整結果</h4>
    <div class="calculation-item">
      <span class="label">標準賞与額：</span>
      <span class="value highlight">{{ cr.standardBonus | number : "1.0-0" }}円</span>
    </div>
    <div
      class="calculation-item"
      *ngIf="cr.cappedBonusHealth !== cr.standardBonus"
    >
      <span class="label">健保・介保上限適用後：</span>
      <span class="value">{{ cr.cappedBonusHealth | number : "1.0-0" }}円</span>
    </div>
    <div
      class="calculation-item"
      *ngIf="cr.cappedBonusPension !== cr.standardBonus"
    >
      <span class="label">厚年上限適用後：</span>
      <span class="value">{{ cr.cappedBonusPension | number : "1.0-0" }}円</span>
    </div>
  </div>

  <!-- 2. 保険料一覧 -->
  <div class="info-section">
    <h4>保険料一覧</h4>
    <div class="calculation-item">
      <span class="label">健康保険（本人）：</span>
      <span class="value">{{ cr.healthEmployee | number : "1.0-0" }}円</span>
    </div>
    <div class="calculation-item">
      <span class="label">健康保険（会社）：</span>
      <span class="value">{{ cr.healthEmployer | number : "1.0-0" }}円</span>
    </div>
    <div class="calculation-item">
      <span class="label">介護保険（本人）：</span>
      <span class="value">{{ cr.careEmployee | number : "1.0-0" }}円</span>
    </div>
    <div class="calculation-item">
      <span class="label">介護保険（会社）：</span>
      <span class="value">{{ cr.careEmployer | number : "1.0-0" }}円</span>
    </div>
    <div class="calculation-item">
      <span class="label">厚生年金（本人）：</span>
      <span class="value">{{ cr.pensionEmployee | number : "1.0-0" }}円</span>
    </div>
    <div class="calculation-item">
      <span class="label">厚生年金（会社）：</span>
      <span class="value">{{ cr.pensionEmployer | number : "1.0-0" }}円</span>
    </div>
  </div>

  <!-- 3. 特記事項 -->
  <div
    class="special-notes"
    *ngIf="
      cr.isExempted || cr.isRetiredNoLastDay || cr.isOverAge70 || cr.isOverAge75 || cr.exemptReason || cr.isSalaryInsteadOfBonus
    "
  >
    <h4>特記事項</h4>
    <div class="warning-card" *ngIf="cr.exemptReason">
      <span class="warning-text">{{ cr.exemptReason }}</span>
    </div>
    <div class="warning-card" *ngIf="cr.isSalaryInsteadOfBonus">
      <span class="warning-text">{{ cr.reason_bonus_to_salary_text }}</span>
    </div>
    <div class="warning-card" *ngIf="cr.isRetiredNoLastDay">
      <span class="warning-text">月末在籍がないため健保・介保保険料0円</span>
    </div>
    <div class="warning-card" *ngIf="cr.isOverAge70">
      <span class="warning-text">70歳到達月のため厚生年金保険料停止</span>
    </div>
    <div class="warning-card" *ngIf="cr.isOverAge75">
      <span class="warning-text">75歳到達月のため健保・介保保険料停止</span>
    </div>
  </div>

  <div class="info-section">
    <h4>届出情報</h4>
    <div class="calculation-item">
      <span class="label">賞与支払届：</span>
      <span class="value">{{ cr.reportRequired ? "提出 ○" : "提出 ×" }}</span>
    </div>
    <div class="calculation-item">
      <span class="label">賞与支払届が必要：</span>
      <span class="value">{{ cr.needsNotification ? "はい" : "いいえ" }}</span>
    </div>
    <div class="calculation-item">
      <span class="label">提出期限：</span>
      <span class="value">{{ cr.deadline }}</span>
    </div>
  </div>
</div>

<ng-container *ngIf="calculationResult as cr">
  <ng-container *ngIf="cr.reasons as reasons">
    <div class="reason-card" *ngIf="reasons.length > 0">
      <h4>適用された実務ルール</h4>
      <ul>
        <li *ngFor="let r of reasons">{{ r }}</li>
      </ul>
    </div>
  </ng-container>
</ng-container>

<div class="report-section" *ngIf="calculationResult as cr">
  <h4>賞与支払届の提出</h4>

  <div *ngIf="cr.requireReport; else noReport">
    <p class="need-report">提出が必要です</p>
    <p>理由：{{ cr.reportReason }}</p>
    <p>提出期限：{{ cr.reportDeadline }}</p>
  </div>

  <ng-template #noReport>
    <p class="no-report">提出は不要です</p>
    <p>理由：{{ cr.reportReason }}</p>
  </ng-template>
</div>

<!-- 賞与一覧 -->
<div class="bonus-list-section card" *ngIf="selectedEmployeeId">
  <h3>賞与一覧（{{ year }}年度）</h3>
  
  <div *ngIf="filteredBonuses.length === 0" class="no-data-message" style="padding: 2rem; text-align: center; color: #666;">
    賞与データがありません
  </div>

  <table class="bonus-list" *ngIf="filteredBonuses.length > 0">
    <thead>
      <tr>
        <th>支給日</th>
        <th>賞与額</th>
        <th>標準賞与額</th>
        <th>健康保険<br>本人/会社</th>
        <th>介護保険<br>本人/会社</th>
        <th>厚生年金<br>本人/会社</th>
        <th>合計</th>
        <th>状態</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let bonus of filteredBonuses">
        <td>{{ bonus.payDate }}</td>
        <td>{{ bonus.amount | number:'1.0-0' }}円</td>
        <td>{{ bonus.standardBonusAmount || 0 | number:'1.0-0' }}円</td>
        <td>
          {{ bonus.healthEmployee || 0 | number:'1.0-0' }} / {{ bonus.healthEmployer || 0 | number:'1.0-0' }}
        </td>
        <td>
          {{ bonus.careEmployee || 0 | number:'1.0-0' }} / {{ bonus.careEmployer || 0 | number:'1.0-0' }}
        </td>
        <td>
          {{ bonus.pensionEmployee || 0 | number:'1.0-0' }} / {{ bonus.pensionEmployer || 0 | number:'1.0-0' }}
        </td>
        <td>{{ getBonusTotal(bonus) | number:'1.0-0' }}円</td>
        <td>
          <span *ngIf="bonus.isExempted || bonus.isExempt" class="exempt">免除中</span>
          <span *ngIf="bonus.isSalaryInsteadOfBonus" class="salary-mode">給与扱い</span>
          <span *ngIf="!bonus.isExempted && !bonus.isExempt && !bonus.isSalaryInsteadOfBonus">-</span>
        </td>
        <td>
          <a [routerLink]="['/bonus', bonus.employeeId, bonus.id, 'edit']" [queryParams]="{year: year}" class="btn-link" style="margin-right: 0.5rem;">編集</a>
          <button (click)="deleteBonus(bonus)" class="btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.9rem;">削除</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- CSVインポート -->
<div class="card" style="margin-top: 2rem;">
  <h3>CSVインポート</h3>
  <p style="color: #666; margin-bottom: 1rem;">
    CSV形式: employeeId, payDate, bonusAmount, notes<br>
    例: E001, 2025-06-30, 500000, 夏季賞与
  </p>
  <div class="form-group">
    <label for="csvFile">CSVファイルを選択：</label>
    <input
      id="csvFile"
      type="file"
      accept=".csv"
      (change)="onCsvUpload($event)"
      class="form-control"
      style="padding: 0.5rem;"
    />
  </div>

  <!-- インポート結果表示 -->
  <div *ngIf="importResult" class="import-result" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
    <h4>インポート結果</h4>
    <p><strong>成功:</strong> {{ importResult.successCount }}件</p>
    <p *ngIf="importResult.errorCount > 0"><strong>失敗:</strong> {{ importResult.errorCount }}件</p>
    <div *ngIf="importResult.errors.length > 0" style="margin-top: 0.5rem;">
      <strong>エラー詳細（最大10件）:</strong>
      <ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: #dc3545;">
        <li *ngFor="let error of importResult.errors">{{ error }}</li>
      </ul>
    </div>
  </div>
</div>

