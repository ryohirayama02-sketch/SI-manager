<h2>賞与入力</h2>

<div class="card" style="max-width: 600px; margin-bottom: 1rem">
  <div class="form-group">
    <label>年度：</label>
    <select
      [(ngModel)]="year"
      (change)="onYearChange()"
      class="form-control"
      [ngModelOptions]="{ standalone: true }"
    >
      <option *ngFor="let y of availableYears" [value]="y">{{ y }}年</option>
    </select>
  </div>
</div>

<app-bonus-csv-import
  [csvImportResult]="csvImportResult"
  (csvTextImport)="onCsvTextImport($event)"
  (closeDialog)="onCsvImportClose()"
>
</app-bonus-csv-import>

<div class="info-label" *ngIf="bonusColumns.length > 0">
  賞与支給額を入力してください。<br />
  <br />
  ※就業規則・賃金規程などで年間4回以上支給と客観的に定められている場合は、賞与入力はせず、「賞与に係る報酬」として毎月の月次給与に（7月ー6月の賞与合計額を12で除した額）を入力してください。
</div>

<div class="card" style="margin-bottom: 1rem">
  <button
    (click)="addBonusColumn()"
    class="btn-success"
    style="margin-bottom: 1rem"
  >
    ＋ 賞与入力列を追加
  </button>

  <div class="bonus-table-wrapper" *ngIf="bonusColumns.length > 0">
    <table class="bonus-table">
      <thead>
        <tr>
          <th class="sticky-col">従業員</th>
          <th *ngFor="let column of bonusColumns" class="bonus-column-header">
            <div class="column-header-content">
              <div class="pay-date-input">
                <label>支給日：</label>
                <input
                  type="date"
                  [value]="column.payDate"
                  (change)="
                    onPayDateChange(column.id, $any($event.target).value)
                  "
                  class="form-control"
                  style="
                    width: auto;
                    display: inline-block;
                    margin-left: 0.5rem;
                  "
                />
              </div>
              <button
                (click)="removeBonusColumn(column.id)"
                class="btn-danger btn-small"
                style="
                  margin-left: 0.5rem;
                  padding: 0.4rem 0.8rem;
                  font-size: 0.9rem;
                  width: auto;
                  align-self: flex-start;
                "
                [disabled]="!column.payDate"
              >
                削除
              </button>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let emp of employees">
          <td class="sticky-col">{{ emp.name }}</td>
          <td
            *ngFor="let column of bonusColumns"
            [ngClass]="{
              'exempt-month': isBonusExempt(emp.id, column.payDate)
            }"
          >
            <!-- 免除（産休/育休）時は入力不可でラベル表示 -->
            <div
              *ngIf="isBonusExempt(emp.id, column.payDate)"
              class="exempt-label"
            >
              {{ getBonusExemptReason(emp.id, column.payDate) || "免除中" }}
            </div>
            <!-- 通常月の場合 -->
            <input
              *ngIf="!isBonusExempt(emp.id, column.payDate)"
              type="text"
              [value]="formatAmount(getBonusAmount(column.id, emp.id))"
              (input)="onBonusInput(column.id, emp.id, $event)"
              (blur)="onBonusBlur(column.id, emp.id, $event)"
              placeholder="0"
              class="form-control"
              [disabled]="!column.payDate"
            />
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p *ngIf="bonusColumns.length === 0" class="info-text">
    「賞与入力列を追加」ボタンをクリックして、賞与入力列を追加してください。
  </p>
</div>

<button
  (click)="saveAllBonuses()"
  class="btn-primary"
  [ngClass]="{ 'btn-saving': isSaving }"
  [disabled]="isSaving"
  style="margin-top: 1rem"
>
  {{ isSaving ? "保存中..." : "保存する" }}
</button>
