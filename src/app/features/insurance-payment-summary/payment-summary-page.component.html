<!-- ローディングインジケータ -->
<app-loading-indicator
  [isLoading]="state.isLoading"
  message="集計中..."
></app-loading-indicator>

<!-- ヘッダー -->
<app-payment-summary-header [year]="state.year"></app-payment-summary-header>

<!-- タブ切替 -->
<!-- タブ切替 -->
<div class="tabs-container">
  <div class="tabs">
    <button
      type="button"
      class="tab-button"
      [class.active]="activeTab === 'summary'"
      (click)="setTab('summary')"
    >
      振込額集計
    </button>
    <button
      type="button"
      class="tab-button"
      [class.active]="activeTab === 'notice'"
      (click)="setTab('notice')"
    >
      納入告知額
    </button>
  </div>
  <div class="tabs-underline"></div>
</div>

<!-- 年度選択（位置をタブの直下に配置） -->
<div class="card" style="margin-bottom: 1rem; max-width: 600px">
  <div style="display: flex; gap: 1rem; align-items: center">
    <div class="form-group" style="margin-bottom: 0">
      <label>年度：</label>
      <select
        [(ngModel)]="state.year"
        (change)="onYearChange()"
        class="form-control"
        [ngModelOptions]="{ standalone: true }"
      >
        <option *ngFor="let y of state.availableYears" [value]="y">
          {{ y }}年
        </option>
      </select>
    </div>
  </div>
</div>

<!-- 振込額集計タブ -->
<ng-container *ngIf="activeTab === 'summary'">
  <!-- 年間 振込額一覧（1〜12月） -->
  <div class="card" style="margin-top: 1.5rem">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      "
    >
      <h3 style="margin: 0">年間振込額一覧（{{ state.year }}年度）</h3>
      <span style="font-size: 0.85rem; color: #666">単位：円</span>
    </div>

    <table
      class="premium-table"
      style="width: 100%; border-collapse: collapse; margin-top: 0.5rem"
    >
      <thead>
        <tr>
          <th style="width: 12%">月</th>
          <th style="width: 29%">従業員負担分</th>
          <th style="width: 29%">会社負担分</th>
          <th style="width: 30%">振込合計（納入告知額）</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let m of state.months">
          <td class="month-cell">{{ m }}月</td>
          <td class="amount-cell">
            {{
              getMonthlyTotals(state.year, m).totalEmployee +
                getBonusTotals(state.year, m).totalEmployee || 0
                | number : "1.0-0"
            }}
          </td>
          <td class="amount-cell">
            {{
              getNoticeAmountForMonth(m) -
                (getMonthlyTotals(state.year, m).totalEmployee +
                  getBonusTotals(state.year, m).totalEmployee || 0)
                | number : "1.0-0"
            }}
          </td>
          <td class="amount-cell total-cell">
            {{ getNoticeAmountForMonth(m) | number : "1.0-0" }}
          </td>
        </tr>
      </tbody>
    </table>

    <div style="margin-top: 1rem; text-align: right">
      <button type="button" class="btn-primary" (click)="exportAnnualTableCsv()">
        年間振込額一覧をCSV出力
      </button>
    </div>
  </div>

  <!-- 年間警告パネル -->
  <app-annual-warning-panel
    [warnings]="state.warnings"
  ></app-annual-warning-panel>

  <div *ngIf="state.employees.length === 0" class="no-data-message">
    <p>データがありません</p>
  </div>

  <!-- エラー・警告メッセージ（従業員ごと） -->
  <app-error-panel
    [employees]="getFilteredEmployees()"
    [errorMessages]="state.errorMessages"
    [warningMessages]="state.warningMessages"
  ></app-error-panel>
</ng-container>

<!-- 納入告知額タブ -->
<ng-container *ngIf="activeTab === 'notice'">
  <div class="card" style="margin-bottom: 1rem; max-width: 600px">
    <h3>納入告知額（{{ state.year }}年度）</h3>
    <div
      style="
        position: relative;
        width: 360px;
        max-width: 100%;
        margin: 0 auto 1rem;
      "
    >
      <p
        style="
          position: absolute;
          right: 0;
          top: -1.5rem;
          margin: 0;
          color: #666;
          font-size: 0.9rem;
        "
      >
        単位：円
      </p>
      <table
        class="premium-table"
        style="width: 100%; border-collapse: collapse"
      >
        <thead>
          <tr>
            <th style="width: 20%">月</th>
            <th style="width: 80%">納入告知額</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let m of noticeMonths">
            <td class="month-cell">{{ m }}月</td>
            <td class="amount-cell">
              <input
                type="text"
                inputmode="numeric"
                #noticeInput
                class="form-control"
                style="width: 200px; text-align: right"
                [value]="noticeAmountInputs[m]"
                (input)="onNoticeAmountInput(m, noticeInput.value)"
              />
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div
      style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center"
    >
      <button
        type="button"
        class="btn-primary"
        [ngClass]="{ 'btn-saving': isSavingNotice }"
        [disabled]="isSavingNotice"
        (click)="saveNoticeAmounts()"
      >
        {{ isSavingNotice ? "保存中..." : "保存" }}
      </button>
    </div>
  </div>
</ng-container>
