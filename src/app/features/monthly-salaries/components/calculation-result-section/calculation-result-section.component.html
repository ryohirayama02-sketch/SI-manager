<ng-container *ngFor="let emp of employees">
  <div class="result-card" *ngIf="getCalculatedInfo(emp) as info">
    <h4>{{ emp.name }} の計算結果</h4>

    <!-- 定時決定結果 -->
    <div *ngIf="results[emp.id]" style="margin-bottom: 1rem; padding: 8px; background: #f0f0f0; border-radius: 4px;">
      <h5 style="margin-top: 0;">定時決定（4〜6月の算定基礎）</h5>
      <p><strong>4〜6月の平均報酬:</strong> {{ results[emp.id].averageSalary ?? 0 | number:'1.0-0' }} 円</p>
      <p *ngIf="results[emp.id] && results[emp.id].excludedMonths && results[emp.id].excludedMonths.length > 0">
        <strong>算定除外月:</strong> {{ (results[emp.id].excludedMonths ?? []).join(', ') }}月
      </p>
      <p *ngIf="!results[emp.id].excludedMonths || results[emp.id].excludedMonths.length === 0">
        <strong>算定除外月:</strong> なし
      </p>
      <p><strong>標準報酬月額:</strong> {{ results[emp.id].standardMonthlyRemuneration ?? 0 | number:'1.0-0' }} 円（等級: {{ results[emp.id].grade ?? '-' }}）</p>
    </div>
  </div>
</ng-container>

<div *ngIf="suijiCandidates.length > 0" style="margin-top: 2rem;">
  <h4 class="suiji-title">随時改定候補（固定的賃金の変動）</h4>
  
  <div class="suiji-card" *ngFor="let item of suijiCandidates">
    <div class="suiji-row">
      <div class="col-left">
        <p class="name">{{ item.name }}</p>
        <p class="small">変動月：{{ item.changedMonth }}月</p>
        <p class="small" *ngIf="item.excludedMonths.length > 0">
          算定除外月：{{ item.excludedMonths.join(', ') }}月
        </p>
      </div>

      <div class="col-right">
        <p>平均固定：{{ item.avgFixed | number:'1.0-0' }}円</p>
        <p>
          等級差：
          <span class="suiji-badge" [class.bad]="item.gradeDiff >= 2">
            {{ item.currentGrade }} → {{ item.newGrade }}（差：{{ item.gradeDiff }}）
          </span>
        </p>
        <p>適用開始月：{{ item.applyMonth }}月</p>
      </div>
    </div>

    <div class="notice">
      <p *ngIf="item.gradeDiff >= 2">→ 月額変更届の提出が必要な可能性があります</p>
      <p *ngIf="item.gradeDiff < 2">→ 今回は等級差が基準未満のため、提出不要</p>
    </div>
  </div>
</div>

<div *ngIf="excludedSuijiReasons.length > 0" style="margin-top: 2rem;">
  <h4>随時改定が適用されないケース</h4>
  <div class="suiji-excluded" *ngFor="let ex of excludedSuijiReasons">
    <p><strong>{{ ex.name }}</strong></p>
    <p>{{ ex.reason }}</p>
  </div>
</div>

<div *ngIf="rehabSuijiCandidates.length > 0" class="rehab-section">
  <h4>復職関連の随時改定候補</h4>
  <div class="rehab-card" *ngFor="let item of rehabSuijiCandidates">
    <p class="name">{{ getEmployeeName(item.employeeId) }}</p>
    <p>判定対象月：{{ item.changeMonth }}月</p>
    <p>固定的賃金３ヶ月平均：{{ item.averageSalary | number:'1.0-0' }}円</p>
    <p>等級差：{{ item.currentGrade }} → {{ item.newGrade }}（差：{{ item.diff }}）</p>
    <p>適用開始月：{{ item.applyStartMonth }}月</p>
    <p>復職に伴う賃金変動により、随時改定の対象となる可能性があります。</p>
  </div>
</div>

<!-- 随時改定アラートダイアログ -->
<div class="overlay" *ngIf="showSuijiDialog" (click)="onCloseSuijiDialog()">
  <div class="dialog" (click)="$event.stopPropagation()">
    <h3>随時改定アラート</h3>
    <p>随時改定候補が {{ suijiAlerts.length }} 件あります</p>
    <div style="margin-top: 1rem;">
      <button (click)="onNavigateToSuijiAlert()" class="btn-primary" style="margin-right: 0.5rem;">→ アラート一覧へ移動</button>
      <button (click)="onCloseSuijiDialog()" class="btn-secondary">閉じる</button>
    </div>
  </div>
</div>

