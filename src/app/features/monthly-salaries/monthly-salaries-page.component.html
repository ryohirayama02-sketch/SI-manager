<h2>月次給与・報酬入力</h2>

<div class="info-label">
  <strong>重要:</strong> 4〜6月の値は算定基礎届の判定に使用されます。固定的賃金と非固定的賃金の合計が総支給と一致するように入力してください。
</div>

<div class="card" style="max-width: 400px;">
  <div class="form-group">
    <label>都道府県：</label>
    <select [(ngModel)]="prefecture" (change)="reloadRates()" name="prefecture" class="form-control">
      <option value="tokyo">東京都</option>
      <option value="hokkaido">北海道</option>
      <option value="osaka">大阪府</option>
    </select>
  </div>
</div>

<div class="legend">
  ■ 復職後3ヶ月の期間（随時改定が発生しやすい期間）
</div>

<table class="salary-table">
  <thead>
    <tr>
      <th>従業員</th>
      <th *ngFor="let m of months">{{ m }}月</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let emp of employees">
      <td>{{ emp.name }}</td>
      <td *ngFor="let m of months" [ngClass]="{ 'rehab-highlight': getRehabHighlightMonths(emp).includes(m) }">
        <div style="display: flex; flex-direction: column; gap: 4px;">
          <input
            type="number"
            [(ngModel)]="salaries[getSalaryKey(emp.id, m)].total"
            (input)="onSalaryChange(emp.id, m)"
            placeholder="総支給"
            class="form-control"
            name="total_{{emp.id}}_{{m}}"
            min="0"
            step="1"
          />
          <input
            type="number"
            [(ngModel)]="salaries[getSalaryKey(emp.id, m)].fixed"
            placeholder="固定"
            (input)="onFixedChange(emp.id, m)"
            class="form-control"
            name="fixed_{{emp.id}}_{{m}}"
            min="0"
            step="1"
          />
          <input
            type="number"
            [(ngModel)]="salaries[getSalaryKey(emp.id, m)].variable"
            placeholder="非固定"
            class="form-control"
            name="variable_{{emp.id}}_{{m}}"
            min="0"
            step="1"
          />
        </div>
      </td>
    </tr>
  </tbody>
</table>

<!-- エラー・警告メッセージ -->
<div *ngFor="let emp of employees">
  <div *ngIf="errorMessages[emp.id]?.length" class="error-box">
    <h4>エラー（{{ emp.name }}）</h4>
    <ul>
      <li *ngFor="let err of errorMessages[emp.id]">{{ err }}</li>
    </ul>
  </div>
  
  <div *ngIf="warningMessages[emp.id]?.length" class="warning-box">
    <h4>警告（{{ emp.name }}）</h4>
    <ul>
      <li *ngFor="let w of warningMessages[emp.id]">{{ w }}</li>
    </ul>
  </div>
</div>

<ng-container *ngFor="let emp of employees">
  <div class="result-card" *ngIf="getCalculatedInfo(emp) as info">
    <h4>{{ emp.name }} の計算結果</h4>

    <!-- 定時決定結果 -->
    <div *ngIf="results[emp.id]" style="margin-bottom: 1rem; padding: 8px; background: #f0f0f0; border-radius: 4px;">
      <h5 style="margin-top: 0;">定時決定（4〜6月の算定基礎）</h5>
      <p><strong>4〜6月の平均報酬:</strong> {{ results[emp.id].average46 | number:'1.0-0' }} 円</p>
      <p *ngIf="results[emp.id].excludedMonths.length > 0">
        <strong>算定除外月:</strong> {{ results[emp.id].excludedMonths.join(', ') }}月
      </p>
      <p *ngIf="results[emp.id].excludedMonths.length === 0">
        <strong>算定除外月:</strong> なし
      </p>
      <p><strong>標準報酬月額:</strong> {{ results[emp.id].standardMonthlyRemuneration | number:'1.0-0' }} 円（等級: {{ results[emp.id].grade }}）</p>
    </div>

    <!-- 既存の計算結果（後方互換性のため残す） -->
    <p><strong>4〜6月の平均報酬:</strong> {{ info.avg | number:'1.0-0' }} 円</p>
    <p><strong>標準報酬月額:</strong> {{ info.standard | number:'1.0-0' }} 円（等級: {{ info.rank }}）</p>

    <div class="premium-group" *ngIf="info.premiums">
      <h5>健康保険</h5>
      <p>本人: {{ info.premiums.health_employee | number:'1.0-0' }} 円</p>
      <p>事業主: {{ info.premiums.health_employer | number:'1.0-0' }} 円</p>
    </div>

    <div class="premium-group" *ngIf="info.premiums && info.premiums.care_employee !== null && info.premiums.care_employee !== 0">
      <h5>介護保険</h5>
      <p>本人: {{ info.premiums.care_employee | number:'1.0-0' }} 円</p>
      <p>事業主: {{ info.premiums.care_employer | number:'1.0-0' }} 円</p>
    </div>

    <div class="premium-group" *ngIf="info.premiums">
      <h5>厚生年金</h5>
      <p>本人: {{ info.premiums.pension_employee | number:'1.0-0' }} 円</p>
      <p>事業主: {{ info.premiums.pension_employer | number:'1.0-0' }} 円</p>
    </div>
  </div>
</ng-container>

<button (click)="saveAllSalaries()" class="btn-success" style="margin-top: 1rem;">
  保存する
</button>

<div *ngIf="suijiCandidates.length > 0" style="margin-top: 2rem;">
  <h4 class="suiji-title">随時改定候補（固定的賃金の変動）</h4>
  
  <div class="suiji-card" *ngFor="let item of suijiCandidates">
    <div class="suiji-row">
      <div class="col-left">
        <p class="name">{{ item.name }}</p>
        <p class="small">変動月：{{ item.changedMonth }}月</p>
        <p class="small" *ngIf="item.excludedMonths.length > 0">
          算定除外月：{{ item.excludedMonths.join(', ') }}月
        </p>
      </div>

      <div class="col-right">
        <p>平均固定：{{ item.avgFixed | number:'1.0-0' }}円</p>
        <p>
          等級差：
          <span class="suiji-badge" [class.bad]="item.gradeDiff >= 2">
            {{ item.currentGrade }} → {{ item.newGrade }}（差：{{ item.gradeDiff }}）
          </span>
        </p>
        <p>適用開始月：{{ item.applyMonth }}月</p>
      </div>
    </div>

    <div class="notice">
      <p *ngIf="item.gradeDiff >= 2">→ 月額変更届の提出が必要な可能性があります</p>
      <p *ngIf="item.gradeDiff < 2">→ 今回は等級差が基準未満のため、提出不要</p>
    </div>
  </div>
</div>

<div *ngIf="excludedSuijiReasons.length > 0" style="margin-top: 2rem;">
  <h4>随時改定が適用されないケース</h4>
  <div class="suiji-excluded" *ngFor="let ex of excludedSuijiReasons">
    <p><strong>{{ ex.name }}</strong></p>
    <p>{{ ex.reason }}</p>
  </div>
</div>

<div *ngIf="rehabSuijiCandidates.length > 0" class="rehab-section">
  <h4>復職関連の随時改定候補</h4>
  <div class="rehab-card" *ngFor="let item of rehabSuijiCandidates">
    <p class="name">{{ item.name }}</p>
    <p>判定対象月：{{ item.changedMonth }}月</p>
    <p>固定的賃金３ヶ月平均：{{ item.avgFixed | number:'1.0-0' }}円</p>
    <p>等級差：{{ item.currentGrade }} → {{ item.newGrade }}（差：{{ item.gradeDiff }}）</p>
    <p>適用開始月：{{ item.applyMonth }}月</p>
    <p>復職に伴う賃金変動により、随時改定の対象となる可能性があります。</p>
  </div>
</div>

