<h2>基本設定</h2>

<div class="card">
  <div class="info-label">
    給与月の判定方式を選択してください。
  </div>
  <form [formGroup]="settingsForm">
    <div class="form-group">
      <label>給与月の判定方式：</label>
      <div>
        <label>
          <input type="radio" formControlName="salaryMonthRule" value="payDate">
          支給日基準（給与が支給された月を給与月とする）
        </label>
      </div>
      <div>
        <label>
          <input type="radio" formControlName="salaryMonthRule" value="closingDate">
          締日基準（給与の締めた月を給与月とする）
        </label>
      </div>
    </div>
  </form>
</div>

<h2>保険料率の設定</h2>

<div class="card">
  <div class="info-label">
    年度ごとに使用する社会保険料率（健保・介護・厚年）を登録してください。
  </div>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <div class="form-group" style="margin-bottom: 0;">
      <label>年度：</label>
      <select [(ngModel)]="year" (change)="onYearChange()" class="form-control" [ngModelOptions]="{standalone: true}">
        <option *ngFor="let y of availableYears" [value]="y.toString()">{{ y }}年</option>
      </select>
    </div>
  </div>

  <!-- 健康保険（47都道府県） -->
  <h3>健康保険（協会けんぽ）</h3>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
    <!-- 左列 -->
    <div style="overflow-x: auto;">
      <table class="rate-table">
        <thead>
          <tr>
            <th style="min-width: 100px;">都道府県</th>
            <th style="min-width: 80px;">健保_本人</th>
            <th style="min-width: 80px;">健保_会社</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pref of getPrefectureListColumn1()">
            <td>{{ pref.name }}</td>
            <td>
              <input 
                type="number" 
                [value]="prefectureRates[pref.code]?.health_employee || 0"
                (input)="onHealthEmployeeInput(pref.code, $event)"
                (blur)="savePrefectureRate(pref.code)"
                class="form-control rate-input"
                min="0" max="1" step="0.0001">
            </td>
            <td>
              <input 
                type="number" 
                [value]="prefectureRates[pref.code]?.health_employer || 0"
                (input)="onHealthEmployerInput(pref.code, $event)"
                (blur)="savePrefectureRate(pref.code)"
                class="form-control rate-input"
                min="0" max="1" step="0.0001">
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- 右列 -->
    <div style="overflow-x: auto;">
      <table class="rate-table">
        <thead>
          <tr>
            <th style="min-width: 100px;">都道府県</th>
            <th style="min-width: 80px;">健保_本人</th>
            <th style="min-width: 80px;">健保_会社</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pref of getPrefectureListColumn2()">
            <td>{{ pref.name }}</td>
            <td>
              <input 
                type="number" 
                [value]="prefectureRates[pref.code]?.health_employee || 0"
                (input)="onHealthEmployeeInput(pref.code, $event)"
                (blur)="savePrefectureRate(pref.code)"
                class="form-control rate-input"
                min="0" max="1" step="0.0001">
            </td>
            <td>
              <input 
                type="number" 
                [value]="prefectureRates[pref.code]?.health_employer || 0"
                (input)="onHealthEmployerInput(pref.code, $event)"
                (blur)="savePrefectureRate(pref.code)"
                class="form-control rate-input"
                min="0" max="1" step="0.0001">
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 介護保険（全国一律） -->
  <h3>介護保険（全国一律）</h3>
  <div class="card" style="max-width: 500px; margin-bottom: 1.5rem;">
    <div class="form-group">
      <label>本人料率：</label>
      <input 
        type="number" 
        [(ngModel)]="careRates.care_employee"
        (blur)="saveAllRates()"
        class="form-control" 
        min="0" max="1" step="0.0001"
        [ngModelOptions]="{standalone: true}">
    </div>
    <div class="form-group">
      <label>事業主料率：</label>
      <input 
        type="number" 
        [(ngModel)]="careRates.care_employer"
        (blur)="saveAllRates()"
        class="form-control" 
        min="0" max="1" step="0.0001"
        [ngModelOptions]="{standalone: true}">
    </div>
  </div>

  <!-- 厚生年金（全国一律） -->
  <h3>厚生年金（全国一律）</h3>
  <div class="card" style="max-width: 500px; margin-bottom: 1.5rem;">
    <div class="form-group">
      <label>本人料率：</label>
      <input 
        type="number" 
        [(ngModel)]="pensionRates.pension_employee"
        (blur)="saveAllRates()"
        class="form-control" 
        min="0" max="1" step="0.0001"
        [ngModelOptions]="{standalone: true}">
    </div>
    <div class="form-group">
      <label>事業主料率：</label>
      <input 
        type="number" 
        [(ngModel)]="pensionRates.pension_employer"
        (blur)="saveAllRates()"
        class="form-control" 
        min="0" max="1" step="0.0001"
        [ngModelOptions]="{standalone: true}">
    </div>
  </div>

  <div class="button-group">
    <button (click)="saveAllRates()" class="btn-primary">すべての料率を保存する</button>
    <button (click)="seedAllPrefectures()" class="btn-secondary">47都道府県の料率（{{ year }}）を初期投入する</button>
  </div>
</div>

<h2>
  標準報酬月額テーブル
  <button 
    type="button" 
    (click)="isStandardTableExpanded = !isStandardTableExpanded"
    style="margin-left: 1rem; padding: 0.25rem 0.5rem; font-size: 0.85rem; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; border-radius: 4px;">
    {{ isStandardTableExpanded ? '折り畳む' : '展開する' }}
  </button>
</h2>

<div class="card" *ngIf="isStandardTableExpanded">
  <div class="info-label">
    標準報酬月額の等級表を設定してください。
  </div>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <div class="form-group" style="margin-bottom: 0;">
      <label>年度：</label>
      <select [(ngModel)]="gradeYear" (change)="onGradeYearChange()" class="form-control" [ngModelOptions]="{standalone: true}">
        <option *ngFor="let y of availableGradeYears" [value]="y.toString()">{{ y }}年</option>
      </select>
    </div>
    <span style="font-size: 0.85rem; color: #666;">単位：円</span>
  </div>
  <form [formGroup]="standardTableForm">
    <div formArrayName="standardTable">
      <table class="grade-table">
        <thead>
          <tr>
            <th>等級</th>
            <th>標準報酬月額</th>
            <th>下限</th>
            <th>上限</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of standardTable.controls; let i = index" [formGroupName]="i">
            <td>{{ row.get('rank')?.value }}</td>
            <td>
              <input 
                type="text" 
                [value]="getAmountDisplayValue(i, 'standard')"
                (input)="onAmountInput(i, 'standard', $event)"
                (blur)="onAmountBlur(i, 'standard', $event)"
                class="form-control">
            </td>
            <td>
              <input 
                type="text" 
                [value]="getAmountDisplayValue(i, 'lower')"
                (input)="onAmountInput(i, 'lower', $event)"
                (blur)="onAmountBlur(i, 'lower', $event)"
                class="form-control">
            </td>
            <td>
              <input 
                type="text" 
                [value]="getAmountDisplayValue(i, 'upper')"
                (input)="onAmountInput(i, 'upper', $event)"
                (blur)="onAmountBlur(i, 'upper', $event)"
                class="form-control">
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </form>

  <!-- エラー・警告メッセージ -->
  <div *ngIf="errorMessages?.length" class="error-box">
    <h4>エラー</h4>
    <ul>
      <li *ngFor="let err of errorMessages">{{ err }}</li>
    </ul>
  </div>

  <div *ngIf="warningMessages?.length" class="warning-box">
    <h4>警告</h4>
    <ul>
      <li *ngFor="let w of warningMessages">{{ w }}</li>
    </ul>
  </div>

  <div style="margin-top: 1rem; display: flex; gap: 1rem;">
    <button (click)="seedStandardTable()" class="btn-primary">標準報酬等級表の初期データを一括登録（50等級）</button>
    <button (click)="saveStandardTable()" class="btn-success">標準報酬月額テーブルを保存する</button>
  </div>
</div>
<div class="card" *ngIf="!isStandardTableExpanded" style="padding: 1rem; text-align: center; color: #666;">
  <p>標準報酬月額テーブルは折り畳まれています。「展開する」ボタンをクリックして表示してください。</p>
</div>

<h2>給与項目マスタ</h2>

<div class="card">
  <div class="info-label">
    給与項目を「固定（fixed）」「非固定（variable）」で分類して管理します。
  </div>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <div class="form-group" style="margin-bottom: 0;">
      <label>年度：</label>
      <select [(ngModel)]="salaryItemsYear" (change)="onSalaryItemsYearChange()" class="form-control" [ngModelOptions]="{standalone: true}">
        <option *ngFor="let y of getAvailableYears()" [value]="y">{{ y }}年</option>
      </select>
    </div>
  </div>
  <form [formGroup]="salaryItemsForm">
    <div formArrayName="salaryItems">
      <div *ngFor="let item of salaryItems.controls; let i = index" [formGroupName]="i" class="row-card">
        <div class="form-group">
          <label>項目名：</label>
          <input type="text" formControlName="name" class="form-control" placeholder="例：基本給" required>
        </div>
        <div class="form-group">
          <label>種別：</label>
          <select formControlName="type" class="form-control" required>
            <option value="fixed">固定</option>
            <option value="variable">非固定</option>
          </select>
        </div>
        <button type="button" (click)="removeSalaryItem(i)" class="btn-secondary" style="margin-top: 0.5rem;">削除</button>
      </div>
    </div>
  </form>
  <button type="button" (click)="addSalaryItem()" class="btn-primary" style="margin-top: 1rem;">項目を追加</button>
  <button type="button" (click)="saveSalaryItems()" class="btn-success" style="margin-top: 1rem; margin-left: 0.5rem;">給与項目マスタを保存する</button>
</div>

