<h2>基本設定</h2>

<div class="card">
  <div class="info-label">
    給与月の判定方式を選択してください。
  </div>
  <form [formGroup]="settingsForm">
    <div class="form-group">
      <label>給与月の判定方式：</label>
      <div>
        <label>
          <input type="radio" formControlName="salaryMonthRule" value="payDate">
          支給日基準（給与が支給された月を給与月とする）
        </label>
      </div>
      <div>
        <label>
          <input type="radio" formControlName="salaryMonthRule" value="closingDate">
          締日基準（給与の締めた月を給与月とする）
        </label>
      </div>
    </div>
  </form>
</div>

<h2>保険料率の設定（{{ year }}年）</h2>

<div class="card">
  <div class="form-group">
    <label>年度：</label>
    <select [(ngModel)]="year" (change)="onYearChange()" class="form-control" [ngModelOptions]="{ standalone: true }">
      <option *ngFor="let y of availableYears" [value]="y.toString()">{{ y }}年</option>
    </select>
  </div>

  <div class="info-label">
    各保険の料率を0以上1以下の範囲で入力してください。
  </div>
  
  <!-- 適用開始月（改定月）管理 -->
  <div class="form-group" style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
    <label><strong>適用開始月（改定月）：</strong></label>
    <form [formGroup]="rateVersionForm">
      <select formControlName="applyFromMonth" class="form-control" style="max-width: 200px; display: inline-block; margin-left: 0.5rem;">
        <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">{{ m }}月</option>
      </select>
    </form>
    <small class="form-text" style="display: block; margin-top: 0.5rem;">この年度の料率改定が適用される月を選択してください（例：4月改定の場合は4を選択）</small>
  </div>
  
  <form [formGroup]="form" (ngSubmit)="save()">
    <div class="form-group">
      <label>都道府県：</label>
      <select formControlName="prefecture" (change)="onPrefectureChange()" class="form-control">
        <option value="hokkaido">北海道</option>
        <option value="aomori">青森県</option>
        <option value="iwate">岩手県</option>
        <option value="miyagi">宮城県</option>
        <option value="akita">秋田県</option>
        <option value="yamagata">山形県</option>
        <option value="fukushima">福島県</option>
        <option value="ibaraki">茨城県</option>
        <option value="tochigi">栃木県</option>
        <option value="gunma">群馬県</option>
        <option value="saitama">埼玉県</option>
        <option value="chiba">千葉県</option>
        <option value="tokyo">東京都</option>
        <option value="kanagawa">神奈川県</option>
        <option value="niigata">新潟県</option>
        <option value="toyama">富山県</option>
        <option value="ishikawa">石川県</option>
        <option value="fukui">福井県</option>
        <option value="yamanashi">山梨県</option>
        <option value="nagano">長野県</option>
        <option value="gifu">岐阜県</option>
        <option value="shizuoka">静岡県</option>
        <option value="aichi">愛知県</option>
        <option value="mie">三重県</option>
        <option value="shiga">滋賀県</option>
        <option value="kyoto">京都府</option>
        <option value="osaka">大阪府</option>
        <option value="hyogo">兵庫県</option>
        <option value="nara">奈良県</option>
        <option value="wakayama">和歌山県</option>
        <option value="tottori">鳥取県</option>
        <option value="shimane">島根県</option>
        <option value="okayama">岡山県</option>
        <option value="hiroshima">広島県</option>
        <option value="yamaguchi">山口県</option>
        <option value="tokushima">徳島県</option>
        <option value="kagawa">香川県</option>
        <option value="ehime">愛媛県</option>
        <option value="kochi">高知県</option>
        <option value="fukuoka">福岡県</option>
        <option value="saga">佐賀県</option>
        <option value="nagasaki">長崎県</option>
        <option value="kumamoto">熊本県</option>
        <option value="oita">大分県</option>
        <option value="miyazaki">宮崎県</option>
        <option value="kagoshima">鹿児島県</option>
        <option value="okinawa">沖縄県</option>
      </select>
    </div>

    <div class="form-group">
      <label>適用開始月：</label>
      <input type="month" formControlName="effectiveFrom" class="form-control" required>
      <small class="form-text">例：2025-04（年度内で複数の料率を管理できます）</small>
    </div>

    <h3>健康保険</h3>
    <div class="form-group">
      <label>本人料率：</label>
      <input type="number" formControlName="health_employee" class="form-control" min="0" max="1" step="0.0001">
    </div>
    <div class="form-group">
      <label>事業主料率：</label>
      <input type="number" formControlName="health_employer" class="form-control" min="0" max="1" step="0.0001">
    </div>

    <h3>介護保険</h3>
    <div class="form-group">
      <label>本人料率：</label>
      <input type="number" formControlName="care_employee" class="form-control" min="0" max="1" step="0.0001">
    </div>
    <div class="form-group">
      <label>事業主料率：</label>
      <input type="number" formControlName="care_employer" class="form-control" min="0" max="1" step="0.0001">
    </div>

    <h3>厚生年金</h3>
    <div class="form-group">
      <label>本人料率：</label>
      <input type="number" formControlName="pension_employee" class="form-control" min="0" max="1" step="0.0001">
    </div>
    <div class="form-group">
      <label>事業主料率：</label>
      <input type="number" formControlName="pension_employer" class="form-control" min="0" max="1" step="0.0001">
    </div>

    <button type="submit" class="btn-primary">保存する</button>
  </form>

  <!-- エラー・警告メッセージ -->
  <div *ngIf="errorMessages?.length" class="error-box">
    <h4>エラー</h4>
    <ul>
      <li *ngFor="let err of errorMessages">{{ err }}</li>
    </ul>
  </div>

  <div *ngIf="warningMessages?.length" class="warning-box">
    <h4>警告</h4>
    <ul>
      <li *ngFor="let w of warningMessages">{{ w }}</li>
    </ul>
  </div>

  <div class="button-group">
    <button (click)="seedTokyo()" class="btn-secondary">東京都の料率（2025）を初期投入する</button>
    <button (click)="seedAllPrefectures()" class="btn-secondary">47都道府県の料率（2025）を初期投入する</button>
  </div>
</div>

<h2>標準報酬月額テーブル</h2>

<div class="card">
  <div class="form-group">
    <label>年度：</label>
    <select [(ngModel)]="gradeYear" (change)="onGradeYearChange()" class="form-control" [ngModelOptions]="{standalone: true}">
      <option *ngFor="let y of availableGradeYears" [value]="y.toString()">{{ y }}年</option>
    </select>
  </div>
  <div class="info-label">
    標準報酬月額テーブルは上限＝次の等級の下限になるように編集してください。等級が連続していない場合はエラーが表示されます。
  </div>
  <form [formGroup]="standardTableForm">
    <div formArrayName="standardTable">
      <div *ngFor="let row of standardTable.controls; let i = index" [formGroupName]="i" class="row-card">
        <h4>等級 {{ row.get('rank')?.value }}</h4>
        <div class="form-group">
          <label>下限：</label>
          <input 
            type="text" 
            [value]="getAmountDisplayValue(i, 'lower')"
            (input)="onAmountInput(i, 'lower', $event)"
            (blur)="onAmountBlur(i, 'lower', $event)"
            class="form-control"> 円
        </div>
        <div class="form-group">
          <label>上限：</label>
          <input 
            type="text" 
            [value]="getAmountDisplayValue(i, 'upper')"
            (input)="onAmountInput(i, 'upper', $event)"
            (blur)="onAmountBlur(i, 'upper', $event)"
            class="form-control"> 円
        </div>
        <div class="form-group">
          <label>標準報酬月額：</label>
          <input 
            type="text" 
            [value]="getAmountDisplayValue(i, 'standard')"
            (input)="onAmountInput(i, 'standard', $event)"
            (blur)="onAmountBlur(i, 'standard', $event)"
            class="form-control"> 円
        </div>
      </div>
    </div>
  </form>

  <!-- エラー・警告メッセージ -->
  <div *ngIf="errorMessages?.length" class="error-box">
    <h4>エラー</h4>
    <ul>
      <li *ngFor="let err of errorMessages">{{ err }}</li>
    </ul>
  </div>

  <div *ngIf="warningMessages?.length" class="warning-box">
    <h4>警告</h4>
    <ul>
      <li *ngFor="let w of warningMessages">{{ w }}</li>
    </ul>
  </div>

  <div style="margin-top: 1rem; display: flex; gap: 1rem;">
    <button (click)="seedStandardTable()" class="btn-primary">標準報酬等級表の初期データを一括登録（50等級）</button>
    <button (click)="saveStandardTable()" class="btn-success">標準報酬月額テーブルを保存する</button>
  </div>
</div>

<h2>給与項目マスタ</h2>

<div class="card">
  <div class="form-group">
    <label>年度：</label>
    <select [(ngModel)]="salaryItemsYear" (change)="onSalaryItemsYearChange()" class="form-control" [ngModelOptions]="{standalone: true}">
      <option *ngFor="let y of getAvailableYears()" [value]="y">{{ y }}年</option>
    </select>
  </div>
  <div class="info-label">
    給与項目を「固定（fixed）」「非固定（variable）」で分類して管理します。
  </div>
  <form [formGroup]="salaryItemsForm">
    <div formArrayName="salaryItems">
      <div *ngFor="let item of salaryItems.controls; let i = index" [formGroupName]="i" class="row-card">
        <div class="form-group">
          <label>項目名：</label>
          <input type="text" formControlName="name" class="form-control" placeholder="例：基本給" required>
        </div>
        <div class="form-group">
          <label>種別：</label>
          <select formControlName="type" class="form-control" required>
            <option value="fixed">固定</option>
            <option value="variable">非固定</option>
          </select>
        </div>
        <button type="button" (click)="removeSalaryItem(i)" class="btn-secondary" style="margin-top: 0.5rem;">削除</button>
      </div>
    </div>
  </form>
  <button type="button" (click)="addSalaryItem()" class="btn-primary" style="margin-top: 1rem;">項目を追加</button>
  <button type="button" (click)="saveSalaryItems()" class="btn-success" style="margin-top: 1rem; margin-left: 0.5rem;">給与項目マスタを保存する</button>
</div>

